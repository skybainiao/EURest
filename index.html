<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">

  <link rel="manifest" href="site.webmanifest">

  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/home.css">
  <meta name="theme-color" content="#fafafa">

  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-storage-compat.js"></script>



  <STYLE>
    #lg {
      font-size: 1em; /* 调整字体大小 */
      height: 40px; /* 调整按钮高度 */
      line-height: 40px; /* 调整行高以垂直居中文本 */
      display: inline-block; /* 使链接表现得更像按钮 */
      text-decoration: none; /* 移除下划线 */
      color: lightblue;
      border-radius: 5px;
    }
  </STYLE>
</head>

<body>

  <!-- Add your site or application content here -->

  <!-- Add your site or application content here -->



  <header>
    <nav>
      <a href="index.html" id="logo">欧洲玩乐网</a>
      <a  id="lg" href="html/login.html"  target="_self">登录/注册</a>
      <ul>
        <li><a id="28" href="#">中餐</a></li>
        <li><a id="12" href="#">西餐</a></li>
        <li><a id="35" href="#">城市</a></li>
        <li><a id="80" href="#">交通</a></li>
        <li><a id="18" href="#">景点</a></li>
        <li><a id="14" href="#">酒店</a></li>


        <!-- add more nav items as needed -->
      </ul>
      <div id="search">
        <input id="searchTxt" type="text" placeholder="搜索餐厅...">
        <button id="searchBt">搜索</button>
      </div>


    </nav>
  </header>



  <main>
    <section class="slide-page" data-index="0">
      <div class="header-section">
        <h1 id="tip">美食推荐</h1>
        <a href="html/post.html">
          <button id="upload">发布</button>
        </a>

      </div>

      <div class="grid-container">

        <!-- Grid Item 1 -->
        <div class="grid-item">
          <a id="item1" class="movie" target="_blank">
            <div class="cover-wp">
              <img id="img1"   alt="餐厅 1">
            </div>
            <p>
              <strong id="s1">标题</strong>
            </p>
            <p id="time1">
              店铺名称
            </p>
            <p id="rating1">
             评分演示部分 Rating:♥♥♥♥♥
            </p>
          </a>
        </div>

        <div class="grid-item">
          <a id="item2" class="movie" target="_blank">
            <div class="cover-wp">
              <img id="img2"  alt="餐厅 2">
            </div>
            <p>
              <strong id="s2">
                标题
              </strong>
            </p>
            <p id="time2">
              店铺名称
            </p>
            <p id="rating2">
              评分演示部分 Rating:♥♥♥♥♥
            </p>
          </a>
        </div>

        <div class="grid-item">
          <a id="item3" class="movie" target="_blank">
            <div class="cover-wp">
              <img id="img3"   alt="餐厅 3">
            </div>
            <p>
              <strong id="s3">
                标题
              </strong>
            </p>
            <p id="time3">
              店铺名称
            </p>
            <p id="rating3">
              评分演示部分 Rating:♥♥♥♥♥
            </p>
          </a>
        </div>

        <div class="grid-item">
          <a id="item4" class="movie" target="_blank">
            <div class="cover-wp">
              <img id="img4"   alt="餐厅 4">
            </div>
            <p>
              <strong id="s4">
                标题
              </strong>
            </p>
            <p id="time4">
              店铺名称
            </p>
            <p id="rating4">
              评分演示部分 Rating:♥♥♥♥♥
            </p>
          </a>
        </div>

        <div class="pagination">
          <button id="prevPage">上一页</button>
          <button id="nextPage">下一页</button>
        </div>




      </div>
    </section>
  </main>

  <script>
    let firebaseConfig = {
      apiKey: "AIzaSyABXKTeI2T16mETkhYohvu4Y1X20hvL3cU",
      authDomain: "eufun-f0a72.firebaseapp.com",
      databaseURL: "https://eufun-f0a72-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "eufun-f0a72",
      storageBucket: "eufun-f0a72.appspot.com",
      messagingSenderId: "1041084911229",
      appId: "1:1041084911229:web:4df4ec093dcf32b2696b14",
      measurementId: "G-PQ3K5KZ2NJ"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    window.onload = function() {
      changeStatus();
      loadPosts(currentPage);
    };

    function changeStatus() {
      let username = localStorage.getItem('username');
      let user = document.getElementById('lg');
      if (username !== null) {
        user.innerHTML = username;
      }
    }

    function checkProfile() {
      let username = localStorage.getItem('username');
      if (username === null) {
        window.location.href = "html/login.html";
      } else {
        window.location.href = "html/profile.html";
      }
    }

    let currentPage = 1;
    const postsPerPage = 4;


    function loadPosts(page) {
      const startIndex = (page - 1) * postsPerPage;
      const endIndex = startIndex + postsPerPage;
      database.ref('shopDetails').once('value').then(snapshot => {
        let allPosts = snapshot.val();
        if (!allPosts) {
          console.error("No posts retrieved from database.");
          return;
        }

        let posts = {}; // Create an object for the current page posts
        let postKeys = Object.keys(allPosts).slice(startIndex, endIndex); // Get the post keys for this page
        postKeys.forEach(key => {
          posts[key] = allPosts[key];
        });

        console.log("Posts for current page:", posts);

        let fetchImageURLPromises = [];

        for (let postId in posts) {
          let shopName = posts[postId].shopName;

          let imageFolderPath = `shopImages/${shopName}/${postId}/`;
          let imageFolderRef = firebase.storage().ref(imageFolderPath);

          let promise = imageFolderRef.listAll().then(result => {
            if (result.items.length === 0) {
              return null; // Replace with your default image URL if needed
            }
            let randomImageRef = result.items[Math.floor(Math.random() * result.items.length)];
            return randomImageRef.getDownloadURL();
          });

          fetchImageURLPromises.push(promise);
        }

        Promise.all(fetchImageURLPromises)
          .then(imageURLs => {
            imageURLs.forEach((imageURL, index) => {
              let postId = Object.keys(posts)[index];
              posts[postId].imageURL = imageURL;
            });

            populatePosts(posts);
          })
          .catch(error => {
            console.error("Error fetching image URLs: ", error);
          });

      }).catch(error => {
        console.error("Error fetching posts from database: ", error);
      });
    }


    function populatePosts(posts) {
      let postArray = Object.values(posts);

      postArray.forEach((post, index) => {
        const item = document.getElementById(`item${index + 1}`);
        const img = document.getElementById(`img${index + 1}`);
        const title = document.getElementById(`s${index + 1}`);
        const shopName = document.getElementById(`time${index + 1}`);
        //const rating = document.getElementById(`rating${index + 1}`);

        item.href = `post.html?id=${post.id}`;
        if (post.imageURL) {
          img.src = post.imageURL;
        } else {
          img.src = 'path_to_default_image.jpg'; // replace this with your default image path
        }
        title.innerText = post.title;
        shopName.innerText = post.shopName;
        //rating.innerText = `评分演示部分 Rating: ${Array(Number(post.rating)).fill('♥').join('')}`;
      });
      if (!posts) {
        console.error("No posts to populate");
        return;
      }
    }

    document.getElementById('nextPage').addEventListener('click', function() {
      currentPage++;
      loadPosts(currentPage);
    });

    document.getElementById('prevPage').addEventListener('click', function() {
      if (currentPage > 1) {
        currentPage--;
        loadPosts(currentPage);
      }
    });

  </script>


  <script src="js/vendor/modernizr-3.11.2.min.js"></script>
  <script src="js/plugins.js"></script>
  <script>




  </script>



  <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-XXXXX-Y', 'auto'); ga('set', 'anonymizeIp', true); ga('set', 'transport', 'beacon'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async></script>
</body>

</html>
