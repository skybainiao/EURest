<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">

  <link rel="manifest" href="site.webmanifest">

  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/home.css">
  <meta name="theme-color" content="#fafafa">

  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-storage-compat.js"></script>



  <STYLE>
    #lg {
      font-size: 1em; /* 调整字体大小 */
      height: 40px; /* 调整按钮高度 */
      line-height: 40px; /* 调整行高以垂直居中文本 */
      display: inline-block; /* 使链接表现得更像按钮 */
      text-decoration: none; /* 移除下划线 */
      color: lightblue;
      border-radius: 5px;
    }


    .pagination {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .pagination button {
      padding: 10px 20px;
      margin: 0 5px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .pagination button:hover {
      background-color: #2980b9;
    }

    .pagination button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }


    /* The modal (background) */
    .modal {
      display: none; /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6); /* Black with a bit of opacity */
      overflow-y: auto; /* Enable scrolling */
    }

    /* Modal content */
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto; /* 5% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 80%; /* Could be more or less, depending on screen size */
      max-height: 80vh;  /* 视口高度的80% */
      overflow-y: scroll;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover, .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    .city-btn {
      margin: 5px;
      padding: 8px 15px;
      cursor: pointer;
      background-color: #007BFF;
      border: none;
      color: white;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }

    .city-btn:hover {
      background-color: #0056b3;
    }

    h2 {
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      margin-top: 20px;
    }

    h3 {
      margin-left: 10px;
    }
  </STYLE>
</head>

<body>

  <!-- Add your site or application content here -->

  <!-- Add your site or application content here -->



  <header>

    <div id="cityModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>

      <h2 style="color: #167e7e">北欧</h2>

      <h3 style="color: #167e7e">瑞典</h3>
      <button class="city-btn">斯德哥尔摩</button>
      <button class="city-btn">哥德堡</button>
      <button class="city-btn">马尔默</button>
      <button class="city-btn">乌普萨拉</button>

      <h3 style="color: #167e7e">挪威</h3>
      <button class="city-btn">奥斯陆</button>
      <button class="city-btn">卑尔根</button>
      <button class="city-btn">斯塔万格</button>
      <button class="city-btn">特隆赫姆</button>

      <h3 style="color: #167e7e">丹麦</h3>
      <button class="city-btn">哥本哈根</button>
      <button class="city-btn">奥胡斯</button>
      <button class="city-btn">奥尔堡</button>
      <button class="city-btn">奥登塞</button>

      <h3 style="color: #167e7e">芬兰</h3>
      <button class="city-btn">赫尔辛基</button>
      <button class="city-btn">坦佩雷</button>
      <button class="city-btn">图尔库</button>
      <button class="city-btn">瓦萨</button>

      <h2 style="color: #167e7e">东欧</h2>

      <h3 style="color: #167e7e">俄罗斯</h3>
      <button class="city-btn">莫斯科</button>
      <button class="city-btn">圣彼得堡</button>

      <h3 style="color: #167e7e">波兰</h3>
      <button class="city-btn">华沙</button>
      <button class="city-btn">克拉科夫</button>

      <h3 style="color: #167e7e">捷克</h3>
      <button class="city-btn">布拉格</button>
      <button class="city-btn">布尔诺</button>
      <button class="city-btn">奥斯特拉瓦</button>

      <h3 style="color: #167e7e">匈牙利</h3>
      <button class="city-btn">布达佩斯</button>
      <button class="city-btn">德布勒森</button>
      <button class="city-btn">塞格德</button>

      <h2 style="color: #167e7e">西欧</h2>

      <h3 style="color: #167e7e">法国</h3>
      <button class="city-btn">巴黎</button>
      <button class="city-btn">里昂</button>
      <button class="city-btn">马赛</button>
      <button class="city-btn">尼斯</button>

      <h3 style="color: #167e7e">德国</h3>
      <button class="city-btn">柏林</button>
      <button class="city-btn">慕尼黑</button>
      <button class="city-btn">法兰克福</button>
      <button class="city-btn">汉堡</button>

      <h3 style="color: #167e7e">英国</h3>
      <button class="city-btn">伦敦</button>
      <button class="city-btn">爱丁堡</button>


      <h3 style="color: #167e7e">荷兰</h3>
      <button class="city-btn">阿姆斯特丹</button>

      <h3 style="color: #167e7e">比利时</h3>
      <button class="city-btn">布鲁塞尔</button>

      <h2 style="color: #167e7e">南欧</h2>

      <h3 style="color: #167e7e">西班牙</h3>
      <button class="city-btn">马德里</button>
      <button class="city-btn">巴塞罗那</button>
      <button class="city-btn">瓦伦西亚</button>
      <button class="city-btn">塞维利亚</button>

      <h3 style="color: #167e7e">意大利</h3>
      <button class="city-btn">罗马</button>
      <button class="city-btn">米兰</button>
      <button class="city-btn">佛罗伦萨</button>
      <button class="city-btn">那不勒斯</button>

      <h3 style="color: #167e7e">葡萄牙</h3>
      <button class="city-btn">里斯本</button>

      <h3 style="color: #167e7e">希腊</h3>
      <button class="city-btn">雅典</button>

      <!-- ...以此类推，你可以继续添加其他国家的城市 -->
    </div>
  </div>

    <nav>
      <a href="index.html" id="logo">欧洲玩乐网</a>
      <a  id="lg" href="html/login.html"  target="_self">登录/注册</a>
      <ul>
        <li><a id="28" href="#">饭店</a></li>
        <li><a id="12" href="#">向导</a></li>
        <li><a id="14" href="#">民宿</a></li>
        <li><a id="18" href="#">景点</a></li>
        <li><a id="80" href="#">交通</a></li>
        <li><a id="35" href="#">城市</a></li>


        <!-- add more nav items as needed -->
      </ul>
      <div id="search">
        <input id="searchTxt" type="text" placeholder="搜索餐厅...">
        <button id="searchBt">搜索</button>
      </div>


    </nav>
  </header>



  <main>
    <section class="slide-page" data-index="0">
      <div class="header-section">
        <h1 id="tip">主页推荐</h1>
        <h2 id="shouCity" style="margin-top: 8%;font-size: 20px" ></h2>
        <a href="html/post.html">
          <button id="upload">发布</button>
        </a>

      </div>

      <div class="grid-container">
        <!-- Grid items will be dynamically inserted here -->
        <div class="pagination">
          <button id="prevPage">上一页</button>
          <button id="nextPage">下一页</button>
        </div>
      </div>


    </section>
  </main>

  <script>
    let firebaseConfig = {
      apiKey: "AIzaSyABXKTeI2T16mETkhYohvu4Y1X20hvL3cU",
      authDomain: "eufun-f0a72.firebaseapp.com",
      databaseURL: "https://eufun-f0a72-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "eufun-f0a72",
      storageBucket: "eufun-f0a72.appspot.com",
      messagingSenderId: "1041084911229",
      appId: "1:1041084911229:web:4df4ec093dcf32b2696b14",
      measurementId: "G-PQ3K5KZ2NJ"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    window.onload = function() {
      changeStatus();
      loadPosts(currentPage, null); // 初始化为 null 类别

// Get the modal
      var modal = document.getElementById('cityModal');

// Get the button that opens the modal
      var btn = document.getElementById('35');

// Get the <span> element that closes the modal
      var span = document.getElementsByClassName('close')[0];

// When the user clicks the button, open the modal
      btn.onclick = function() {
        modal.style.display = "block";
      }

// When the user clicks on <span> (x), close the modal
      span.onclick = function() {
        modal.style.display = "none";
      }

// When the user clicks anywhere outside the modal, close it
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }



      // 为导航链接添加事件监听器
      document.getElementById("28").addEventListener('click', function() {
        loadPosts(currentPage, '饭店');
      });

      document.getElementById("12").addEventListener('click', function() {
        loadPosts(currentPage, '向导');
      });

      document.getElementById("18").addEventListener('click', function() {
        loadPosts(currentPage, '景点');
      });

      document.getElementById("14").addEventListener('click', function() {
        loadPosts(currentPage, '民宿');
      });

      document.getElementById("35").addEventListener('click', function() {
        loadPosts(currentPage, '城市');
      });

      document.getElementById("80").addEventListener('click', function() {
        loadPosts(currentPage, '交通');
      });


      // ... 其他代码 ...

// 获取所有城市按钮的引用
      var cityButtons = document.getElementsByClassName('city-btn');

// 为每个城市按钮添加事件处理器
      for (let btn of cityButtons) {
        btn.addEventListener('click', function() {
          // 更新h2元素以显示所选城市
          document.querySelector('.header-section h2').textContent = "城市: " + btn.textContent;

          // 使用loadPosts方法加载与所选城市相关的帖子
          document.getElementById('shouCity').innerHTML=btn.textContent;
          loadPostsFromCity(currentPage, btn.textContent);  // <--- 这里是关键的调用

          // 关闭模态窗口
          modal.style.display = "none";
        });
      }

// ... 其他代码 ...


    };

    function changeStatus() {
      let username = localStorage.getItem('username');
      let user = document.getElementById('lg');
      let uploadButton = document.getElementById('upload');

      if (username !== null) {
        user.innerHTML = username;
        uploadButton.disabled = false; // 用户已登录，发布按钮可用
      } else {
        user.innerHTML = "登录/注册";
        uploadButton.disabled = true; // 用户未登录，发布按钮不可用
        uploadButton.addEventListener('click', function(event) {
          event.preventDefault(); // 阻止默认事件（链接跳转）
          alert("请先登录！");
        });
      }
    }


    function checkProfile() {
      let username = localStorage.getItem('username');
      if (username === null) {
        window.location.href = "html/login.html";
      } else {
        window.location.href = "html/profile.html";
      }
    }

    let currentPage = 1;
    const postsPerPage = 4;


    function loadPosts(page, storeType) {
      const startIndex = (page - 1) * postsPerPage;
      const endIndex = startIndex + postsPerPage;

      let query = database.ref('shopDetails');

      if (storeType) {
        query = query.orderByChild('storeType').equalTo(storeType);
      }

      query.once('value').then(snapshot => {
        let allPosts = snapshot.val();
        if (!allPosts) {
          console.error("No posts retrieved from database.");
          return;
        }

        // 排序所有帖子，并为每个帖子添加id属性
        let sortedPostsArray = Object.entries(allPosts).map(([id, post]) => ({ ...post, id })).sort((a, b) => b.rating - a.rating);

        // 从已排序的数组中获取当前页面的帖子
        let currentPostsArray = sortedPostsArray.slice(startIndex, endIndex);

        // 转换数组回对象
        let posts = {};
        currentPostsArray.forEach(post => {
          posts[post.id] = post;
        });

        let fetchImageURLPromises = [];

        for (let postId in posts) {
          let shopName = posts[postId].shopName;
          let imageFolderPath = `shopImages/${shopName}/${postId}/`;
          let imageFolderRef = firebase.storage().ref(imageFolderPath);

          let promise = imageFolderRef.listAll().then(result => {
            if (result.items.length === 0) {
              return null;
            }
            let randomImageRef = result.items[Math.floor(Math.random() * result.items.length)];
            return randomImageRef.getDownloadURL();
          });

          fetchImageURLPromises.push(promise);
        }

        Promise.all(fetchImageURLPromises)
          .then(imageURLs => {
            imageURLs.forEach((imageURL, index) => {
              let postId = Object.keys(posts)[index];
              posts[postId].imageURL = imageURL;
            });

            populatePosts(posts);
          })
          .catch(error => {
            console.error("Error fetching image URLs: ", error);
          });

      }).catch(error => {
        console.error("Error fetching posts from database: ", error);
      });






    }

    function loadPostsFromCity(page, city) {
      const startIndex = (page - 1) * postsPerPage;
      const endIndex = startIndex + postsPerPage;

      let query = database.ref('shopDetails');

      if (city) {
        query = query.orderByChild('city').equalTo(city);
      }

      query.once('value').then(snapshot => {
        let allPosts = snapshot.val();

        if (!allPosts) {
          console.error("No posts retrieved from database.");
          return;
        }

        // 排序所有帖子，并为每个帖子添加id属性
        let sortedPostsArray = Object.entries(allPosts).map(([id, post]) => ({ ...post, id })).sort((a, b) => b.rating - a.rating);

        // 从已排序的数组中获取当前页面的帖子
        let currentPostsArray = sortedPostsArray.slice(startIndex, endIndex);

        // 转换数组回对象
        let posts = {};
        currentPostsArray.forEach(post => {
          posts[post.id] = post;
        });

        let fetchImageURLPromises = [];

        for (let postId in posts) {
          let shopName = posts[postId].shopName;
          let imageFolderPath = `shopImages/${shopName}/${postId}/`;
          let imageFolderRef = firebase.storage().ref(imageFolderPath);

          let promise = imageFolderRef.listAll().then(result => {
            if (result.items.length === 0) {
              return null;
            }
            let randomImageRef = result.items[Math.floor(Math.random() * result.items.length)];
            return randomImageRef.getDownloadURL();
          });

          fetchImageURLPromises.push(promise);
        }

        Promise.all(fetchImageURLPromises)
          .then(imageURLs => {
            imageURLs.forEach((imageURL, index) => {
              let postId = Object.keys(posts)[index];
              posts[postId].imageURL = imageURL;
            });

            populatePosts(posts);
          })
          .catch(error => {
            console.error("Error fetching image URLs: ", error);
          });

      }).catch(error => {
        console.error("Error fetching posts from database: ", error);
      });






    }



    // Updated populatePosts function
    function populatePosts(posts) {
      let postArray = Object.values(posts);
      const gridContainer = document.querySelector('.grid-container');

      // Clear current grid items
      gridContainer.innerHTML = '';

      postArray.forEach((post, index) => {
        const gridItem = document.createElement('div');
        gridItem.className = 'grid-item';

        const anchor = document.createElement('a');
        anchor.id = `item${index + 1}`;
        anchor.className = 'movie';
        anchor.target = "_self";
        anchor.href = `html/showPost.html?id=${post.id}`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'content-wrap';
        contentDiv.style.display = 'flex';

        const coverDiv = document.createElement('div');
        coverDiv.className = 'cover-wp';
        coverDiv.style.width = '60%';

        const img = document.createElement('img');
        img.id = `img${index + 1}`;
        if (post.imageURL) {
          img.src = post.imageURL;
        } else {
          img.src = 'path_to_default_image.jpg';
        }
        coverDiv.appendChild(img);
        contentDiv.appendChild(coverDiv);

        const textDiv = document.createElement('div');
        textDiv.style.flexGrow = '1';
        textDiv.style.paddingLeft = '10px';

        const strong = document.createElement('strong');
        strong.id = `s${index + 1}`;
        strong.innerText = post.title;
        textDiv.appendChild(strong);

        const shopNameP = document.createElement('p');
        shopNameP.id = `time${index + 1}`;
        shopNameP.innerText = post.shopName;
        textDiv.appendChild(shopNameP);

        const ratingP = document.createElement('p');
        ratingP.innerText = "评分: " + post.rating;
        textDiv.appendChild(ratingP);

        contentDiv.appendChild(textDiv);
        anchor.appendChild(contentDiv);
        gridItem.appendChild(anchor);
        gridContainer.appendChild(gridItem);
      });

      // Add back the pagination
      gridContainer.innerHTML += `
    <div class="pagination">
      <button id="prevPage">上一页</button>
      <button id="nextPage">下一页</button>
    </div>
    `;

      // Re-attach event listeners to the pagination buttons
      document.getElementById('nextPage').addEventListener('click', function() {
        currentPage++;
        loadPosts(currentPage);
      });

      document.getElementById('prevPage').addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          loadPosts(currentPage);
        }
      });
    }

    function deletePost(postId, gridItem) {
      // 删除firebase中的帖子
      const postRef = database.ref('shopDetails/' + postId);
      postRef.remove()
        .then(function() {
          console.log("Post deleted successfully from Firebase.");
          // 从主页中移除帖子
          gridItem.remove();
        })
        .catch(function(error) {
          console.error("Error deleting post: ", error);
        });
    }









  </script>


  <script src="js/vendor/modernizr-3.11.2.min.js"></script>
  <script src="js/plugins.js"></script>
  <script>




  </script>



  <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-XXXXX-Y', 'auto'); ga('set', 'anonymizeIp', true); ga('set', 'transport', 'beacon'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async></script>
</body>

</html>
